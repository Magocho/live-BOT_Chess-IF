<!DOCTYPE html>
<html>
<head>
  <title>Live Lichess Game with Chessground</title>
  <style>
    #board { width: 400px; height: 400px; margin: auto; }
  </style>

  <!-- Chessground CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessground@8.2.0/dist/chessground.min.css" />
</head>
<body>
  <h2>Live Lichess Game</h2>
  <div id="board"></div>
  <button id="nextBtn">Next Move</button>
  <p id="status"></p>

  <!-- Chessground JS -->
  <script src="https://cdn.jsdelivr.net/npm/chessground@8.2.0/dist/chessground.min.js"></script>
  <!-- chessops for PGN parsing -->
  <script src="https://cdn.jsdelivr.net/npm/chessops@0.19.2/chessops.umd.min.js"></script>

  <script>
    const username = 'ChoBa';  // change this to your lichess username
    const apiUrl = `https://lichess.org/api/games/user/${username}?max=1&moves=true&opening=true&perfType=rapid`;

    let gameMoves = [];
    let currentMove = 0;

    let chess = chessops.Chess.new();
    let cg = Chessground(document.getElementById('board'), {
      coordinates: true,
      movable: { free: false, color: 'white' },
      turnColor: 'white',
      highlight: { lastMove: true, check: true }
    });

    // Fetch latest game PGN from lichess API
    fetch(apiUrl, { headers: { Accept: 'application/x-chess-pgn' } })
      .then(res => res.text())
      .then(pgn => {
        // Parse PGN with chessops
        const games = chessops.Pgn.parse(pgn);
        if (games.length === 0) {
          document.getElementById('status').textContent = 'No recent games found.';
          return;
        }
        chess = chessops.Chess.fromPgn(games[0]);
        gameMoves = chess.legalMoves(); // start from current position
        currentMove = 0;
        cg.set({ fen: chess.fen() });
        document.getElementById('status').textContent = 'Game loaded. Click Next Move.';
      }).catch(() => {
        document.getElementById('status').textContent = 'Failed to load game data.';
      });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentMove >= gameMoves.length) {
        document.getElementById('status').textContent = 'No more moves.';
        return;
      }
      // Make the next move
      chess = chess.applyMove(gameMoves[currentMove]);
      cg.set({ fen: chess.fen() });
      currentMove++;
      document.getElementById('status').textContent = `Move ${currentMove} made.`;
    });
  </script>
</body>
</html>
